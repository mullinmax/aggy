version: '3.8'

networks:
  default:
    external: true
    name: "traefik_default"

services:
  blinder-db:
    image: "redis:latest"
    ports:
      - 6379
    volumes:
      - blinder-db:/data

  # https://github.com/HenryQW/mercury-parser-api
  blinder-extract:
    image: wangqiru/mercury-parser-api
    ports:
      - 3000

  blinder-ingest:
    build: ./src/ingest
    ports:
      - 9001
    environment:
      - REDIS_HOST=blinder-db
      - REDIS_PORT=6379
      - CRON_EXPRESSIONS=0 0/2 * * *
    depends_on:
      - blinder-db
      - blinder-extract

  blinder-webui:
    build: ./src/webui
    ports:
      - 5000
    environment:
      - HOSTNAME=https://codehost.doze.dev
      - REDIS_HOST=blinder-db
      - REDIS_PORT=6379
      - INGEST_HOST=blinder-ingest
      - INGEST_PORT=9001
      - BLINDER_SECRET_KEY=9ud98fhc9e7fh93ufhjd
    labels:
      - "traefik.http.routers.codehost.rule=Host(`codehost.doze.dev`)"
      - "traefik.http.routers.codehost.service=codehost"
      - "traefik.http.services.codehost.loadbalancer.server.port=5000"
    depends_on:
      - blinder-db
      # - blinder-ingest

volumes:
  blinder-db:
